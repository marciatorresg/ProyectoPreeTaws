import{a as re}from"./chunk-6HGRJNLM.js";import{a as ne,g as oe}from"./chunk-ZYVS25A3.js";import{D as te,E as ie,c as V,d as z,e as L,f as N,g as Q,h as $,i as G,j as q,k as W,l as J,m as K,n as X,u as Y,x as Z,y as ee}from"./chunk-6WX2CP4S.js";import"./chunk-RTFPVDOB.js";import"./chunk-FZM53YFU.js";import"./chunk-2D3RX4CC.js";import"./chunk-HB673C6I.js";import"./chunk-HC6MZPB3.js";import"./chunk-4PGTP63H.js";import"./chunk-2Y2A2TBS.js";import"./chunk-FERD25SW.js";import"./chunk-SYQESB6R.js";import"./chunk-LEIMCQKJ.js";import"./chunk-QGFJA56P.js";import{k as T,l as B,n as H,s as U,t as R,z as A}from"./chunk-RD4RCTBO.js";import{$a as F,Ba as h,Ga as b,Ka as w,Sa as u,Ta as n,Ua as i,Va as g,Wa as S,Xa as P,Za as M,_a as O,aa as I,ba as y,db as D,eb as k,fb as j,gb as o,hb as v,ua as E,wa as m}from"./chunk-FX33XUP3.js";import"./chunk-MM5QLNJM.js";import"./chunk-72KDLSWN.js";import"./chunk-5OMUW5VI.js";import"./chunk-OBXDPQ3V.js";import"./chunk-TNKGEIML.js";import"./chunk-MCRJI3T3.js";import"./chunk-3UM7V7MF.js";import"./chunk-EN76HBSE.js";import"./chunk-G4L4XPAN.js";import"./chunk-XKAILZJY.js";import"./chunk-C4KDTZN3.js";import"./chunk-F7XBNY6P.js";import"./chunk-JX3TYZ34.js";import"./chunk-RUY5SX76.js";import"./chunk-NIOQNOHM.js";import"./chunk-VD4IKDYC.js";import"./chunk-JWIEPCRG.js";import"./chunk-LF5XB4YN.js";import{f}from"./chunk-RW4GY4BD.js";var le=["video"];function se(a,r){if(a&1&&(S(0),n(1,"ion-row")(2,"ion-col"),g(3,"img",19),i(),n(4,"ion-col"),o(5),i(),n(6,"ion-col"),o(7),i(),n(8,"ion-col"),o(9),i()(),P()),a&2){let l=r.$implicit;m(3),u("src",l.imagenBase64,E),m(2),v(l.id),m(2),v(l.tipo),m(2),v(l.fecha)}}function me(a,r){if(a&1&&(n(0,"div")(1,"ion-card",1)(2,"ion-card-header")(3,"ion-card-title",15),o(4,"Registers"),i()(),n(5,"ion-card-content")(6,"ion-grid",16)(7,"ion-row",17)(8,"ion-col")(9,"strong"),o(10,"Id"),i()(),n(11,"ion-col")(12,"strong"),o(13,"Register"),i()(),n(14,"ion-col")(15,"strong"),o(16,"Date"),i()()(),w(17,se,10,4,"ng-container",18),i()()()()),a&2){let l=F();m(17),u("ngForOf",l.detecciones)}}ne({"stop-outline":oe});var C=class{constructor(r,l,t,e){this.id=r,this.tipo=l,this.fecha=t,this.imagenBase64=e}},ye=(()=>{let r=class r{constructor(t,e,c){this.http=t,this.toastController=e,this.dataService=c,this.videoStream=null,this.backendUrl="http://127.0.0.1:5000/detect-fire",this.detecciones=[],this.nextId=1}ngOnInit(){}ngAfterViewInit(){this.startCamera()}ngOnDestroy(){this.videoStream&&this.videoStream.getTracks().forEach(t=>t.stop()),clearInterval(this.intervalId)}startCamera(){return f(this,null,function*(){var t;try{this.videoStream=yield navigator.mediaDevices.getUserMedia({video:!0}),(t=this.videoElement)!=null&&t.nativeElement&&(this.videoElement.nativeElement.srcObject=this.videoStream),this.intervalId=setInterval(()=>this.captureFrameAndSend(),2e3)}catch(e){console.error("No se pudo acceder a la c\xE1mara:",e)}})}captureFrameAndSend(){var s;let t=(s=this.videoElement)==null?void 0:s.nativeElement;if(!t)return;let e=document.createElement("canvas");e.width=t.videoWidth||640,e.height=t.videoHeight||480;let c=e.getContext("2d");c&&(c.drawImage(t,0,0,e.width,e.height),e.toBlob(p=>{if(p){let _=new FormData;_.append("file",p,"frame.jpg"),this.http.post(this.backendUrl,_).subscribe({next:d=>f(this,null,function*(){if(d.fire_detected||d.smoke_detected){console.log("\u{1F525} Detecci\xF3n:",d),this.showToast(`Alerta: ${d.fire_detected?"Fuego":""} ${d.smoke_detected?"Humo":""}`);let x=new FileReader;x.onloadend=()=>{let ae=x.result,ce=[d.fire_detected?"FUEGO":"",d.smoke_detected?"HUMO":""].filter(Boolean).join(" y "),de=new C(this.nextId++,ce,new Date().toLocaleString(),ae);this.detecciones.push(de),console.log(this.detecciones)},x.readAsDataURL(p)}}),error:d=>{console.error("Error al enviar el fotograma:",d)}})}},"image/jpeg"))}showToast(t){return f(this,null,function*(){(yield this.toastController.create({message:t,duration:3e3,color:"danger",position:"top"})).present()})}sendDetecciones(){let t=this.detecciones.map(e=>e.imagenBase64);this.dataService.setDetecciones(t)}};r.\u0275fac=function(e){return new(e||r)(h(U),h(te),h(re))},r.\u0275cmp=b({type:r,selectors:[["app-principal-page"]],viewQuery:function(e,c){if(e&1&&D(le,5),e&2){let s;k(s=j())&&(c.videoElement=s.first)}},decls:27,vars:1,consts:[["video",""],["color","dark"],[1,"header-title",2,"display","flex","align-items","center","justify-content","center"],["src","assets/images/Logo.png","alt","Logo","height","80","width","80",2,"margin-top","25px","margin-bottom","16px"],[1,"text-white","center"],[1,"camera-container"],[1,"camera-box"],["autoplay","","muted","","playsinline",""],[1,"camera-grid"],[1,"no-signal-box"],[3,"click"],[4,"ngIf"],["slot","middle"],["role","button"],["name","stop-outline","size","large"],[1,"center","text-white"],[1,"custom-grid"],[1,"header-row"],[4,"ngFor","ngForOf"],["alt","Detecci\xF3n","width","100",3,"src"]],template:function(e,c){if(e&1){let s=M();n(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-title",2),g(3,"img",3),i()()(),n(4,"ion-content",1)(5,"ion-card",1)(6,"ion-card-header")(7,"ion-card-title",4),o(8,"Main Cameras"),i()(),n(9,"ion-card-content")(10,"div",5)(11,"div",6),g(12,"video",7,0),i(),n(14,"div",8)(15,"div",9),o(16,"Sin se\xF1al"),i(),n(17,"div",9),o(18,"Sin se\xF1al"),i()()()()(),n(19,"button",10),O("click",function(){return I(s),y(c.sendDetecciones())}),o(20,"Enviar Frutas"),i(),w(21,me,18,1,"div",11),i(),n(22,"ion-footer")(23,"ion-toolbar",1)(24,"ion-buttons",12)(25,"ion-button",13),g(26,"ion-icon",14),i()()()()}e&2&&(m(21),u("ngIf",c.detecciones.length>0))},dependencies:[ie,V,z,L,N,Q,$,G,q,W,J,K,X,Y,Z,ee,H,T,B,A,R],styles:[".header-title[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center}.header-title[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{margin-top:25px;margin-bottom:16px}.camera-icon[_ngcontent-%COMP%]{font-size:100px;color:#fff}.text-white[_ngcontent-%COMP%]{color:#fff}.camera-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:10px}.camera-box[_ngcontent-%COMP%]{background-color:#444;width:100%;height:180px;border:2px solid white;border-radius:10px;overflow:hidden}.camera-box[_ngcontent-%COMP%]   video[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.camera-grid[_ngcontent-%COMP%]{display:flex;justify-content:space-between;width:100%;gap:10px}.custom-grid[_ngcontent-%COMP%]{font-family:Courier New,Courier,monospace;font-size:.95rem}.center[_ngcontent-%COMP%]{text-align:center}.header-row[_ngcontent-%COMP%]{background-color:#1e1e1e;color:#fff;font-weight:700;padding:8px 0;border-bottom:1px solid #444}.no-signal-box[_ngcontent-%COMP%]{background-color:#444;color:#fff;width:48%;height:100px;display:flex;align-items:center;justify-content:center;font-weight:700;border-radius:10px;border:2px solid white}"]});let a=r;return a})();export{ye as PrincipalPagePage};
